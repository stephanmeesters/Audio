/* Audio Library for Teensy 3.X
 * Copyright (c) 2014, Paul Stoffregen, paul@pjrc.com
 *
 * Development of this audio library was funded by PJRC.COM, LLC by sales of
 * Teensy and Audio Adaptor boards.  Please support PJRC's efforts to develop
 * open source software by purchasing Teensy or other PJRC products.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice, development funding notice, and this permission
 * notice shall be included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

#ifndef analyze_fft4096_h_
#define analyze_fft4096_h_

#include "Arduino.h"
#include "AudioStream.h"
#include "arm_math.h"
#include "arm_const_structs.h"

//import numpy as np
//from numpy.fft import fft, fftshift
//np.set_printoptions(suppress=True, threshold=5000)
//window = np.round(np.hanning(4096) * 32767)
//print window.astype(int)

const int16_t AudioWindowHanning4096[] __attribute__ ((aligned (4))) = {
0, 0, 0, 0, 0, 0, 1, 1, 1, 2, 2, 2
, 3, 3, 4, 4, 5, 6, 6, 7, 8, 9, 9,10
,11,12,13,14,15,16,17,19,20,21,22,24
,25,26,28,29,31,32,34,36,37,39,41,43
,44,46,48,50,52,54,56,58,60,63,65,67
,69,72,74,76,79,81,84,86,89,92,94,97
, 100, 103, 105, 108, 111, 114, 117, 120, 123, 126, 130, 133
, 136, 139, 142, 146, 149, 153, 156, 159, 163, 167, 170, 174
, 177, 181, 185, 189, 192, 196, 200, 204, 208, 212, 216, 220
, 224, 229, 233, 237, 241, 246, 250, 254, 259, 263, 268, 272
, 277, 282, 286, 291, 296, 300, 305, 310, 315, 320, 325, 330
, 335, 340, 345, 350, 355, 361, 366, 371, 377, 382, 387, 393
, 398, 404, 409, 415, 421, 426, 432, 438, 444, 449, 455, 461
, 467, 473, 479, 485, 491, 497, 504, 510, 516, 522, 529, 535
, 541, 548, 554, 561, 567, 574, 580, 587, 594, 600, 607, 614
, 621, 628, 635, 642, 649, 656, 663, 670, 677, 684, 691, 699
, 706, 713, 720, 728, 735, 743, 750, 758, 765, 773, 781, 788
, 796, 804, 812, 819, 827, 835, 843, 851, 859, 867, 875, 883
, 892, 900, 908, 916, 925, 933, 941, 950, 958, 967, 975, 984
, 992,1001,1010,1018,1027,1036,1045,1054,1062,1071,1080,1089
,1098,1107,1117,1126,1135,1144,1153,1163,1172,1181,1191,1200
,1210,1219,1229,1238,1248,1257,1267,1277,1286,1296,1306,1316
,1326,1336,1346,1356,1366,1376,1386,1396,1406,1416,1427,1437
,1447,1458,1468,1478,1489,1499,1510,1520,1531,1542,1552,1563
,1574,1585,1595,1606,1617,1628,1639,1650,1661,1672,1683,1694
,1705,1716,1728,1739,1750,1762,1773,1784,1796,1807,1819,1830
,1842,1853,1865,1877,1888,1900,1912,1924,1935,1947,1959,1971
,1983,1995,2007,2019,2031,2044,2056,2068,2080,2092,2105,2117
,2129,2142,2154,2167,2179,2192,2204,2217,2230,2242,2255,2268
,2281,2293,2306,2319,2332,2345,2358,2371,2384,2397,2410,2423
,2436,2450,2463,2476,2490,2503,2516,2530,2543,2557,2570,2584
,2597,2611,2624,2638,2652,2665,2679,2693,2707,2721,2735,2748
,2762,2776,2790,2804,2819,2833,2847,2861,2875,2889,2904,2918
,2932,2947,2961,2976,2990,3005,3019,3034,3048,3063,3077,3092
,3107,3122,3136,3151,3166,3181,3196,3211,3226,3241,3256,3271
,3286,3301,3316,3331,3346,3362,3377,3392,3408,3423,3438,3454
,3469,3485,3500,3516,3531,3547,3563,3578,3594,3610,3625,3641
,3657,3673,3689,3705,3721,3737,3753,3769,3785,3801,3817,3833
,3849,3865,3882,3898,3914,3930,3947,3963,3980,3996,4013,4029
,4046,4062,4079,4095,4112,4129,4145,4162,4179,4196,4212,4229
,4246,4263,4280,4297,4314,4331,4348,4365,4382,4399,4416,4434
,4451,4468,4485,4503,4520,4537,4555,4572,4589,4607,4624,4642
,4659,4677,4695,4712,4730,4748,4765,4783,4801,4819,4836,4854
,4872,4890,4908,4926,4944,4962,4980,4998,5016,5034,5052,5071
,5089,5107,5125,5144,5162,5180,5198,5217,5235,5254,5272,5291
,5309,5328,5346,5365,5383,5402,5421,5439,5458,5477,5496,5515
,5533,5552,5571,5590,5609,5628,5647,5666,5685,5704,5723,5742
,5761,5780,5800,5819,5838,5857,5876,5896,5915,5934,5954,5973
,5993,6012,6032,6051,6071,6090,6110,6129,6149,6169,6188,6208
,6228,6247,6267,6287,6307,6327,6346,6366,6386,6406,6426,6446
,6466,6486,6506,6526,6546,6566,6587,6607,6627,6647,6667,6688
,6708,6728,6748,6769,6789,6810,6830,6850,6871,6891,6912,6932
,6953,6973,6994,7015,7035,7056,7077,7097,7118,7139,7160,7180
,7201,7222,7243,7264,7285,7305,7326,7347,7368,7389,7410,7431
,7453,7474,7495,7516,7537,7558,7579,7601,7622,7643,7664,7686
,7707,7728,7750,7771,7792,7814,7835,7857,7878,7900,7921,7943
,7964,7986,8007,8029,8051,8072,8094,8116,8137,8159,8181,8203
,8224,8246,8268,8290,8312,8334,8356,8377,8399,8421,8443,8465
,8487,8509,8531,8554,8576,8598,8620,8642,8664,8686,8709,8731
,8753,8775,8798,8820,8842,8864,8887,8909,8932,8954,8976,8999
,9021,9044,9066,9089,9111,9134,9156,9179,9201,9224,9247,9269
,9292,9315,9337,9360,9383,9405,9428,9451,9474,9497,9519,9542
,9565,9588,9611,9634,9657,9680,9703,9725,9748,9771,9794,9817,9841,9864,9887,9910,9933,9956,9979,10002,10025,10049,10072,10095
,10118,10141,10165,10188,10211,10234,10258,10281,10304,10328,10351,10375
,10398,10421,10445,10468,10492,10515,10539,10562,10586,10609,10633,10656
,10680,10703,10727,10750,10774,10798,10821,10845,10869,10892,10916,10940
,10963,10987,11011,11035,11058,11082,11106,11130,11154,11177,11201,11225
,11249,11273,11297,11321,11345,11369,11392,11416,11440,11464,11488,11512
,11536,11560,11584,11608,11633,11657,11681,11705,11729,11753,11777,11801
,11825,11849,11874,11898,11922,11946,11970,11995,12019,12043,12067,12092
,12116,12140,12164,12189,12213,12237,12262,12286,12310,12335,12359,12383
,12408,12432,12457,12481,12505,12530,12554,12579,12603,12628,12652,12677
,12701,12726,12750,12775,12799,12824,12848,12873,12897,12922,12946,12971
,12996,13020,13045,13069,13094,13119,13143,13168,13193,13217,13242,13267
,13291,13316,13341,13365,13390,13415,13440,13464,13489,13514,13539,13563
,13588,13613,13638,13662,13687,13712,13737,13762,13786,13811,13836,13861
,13886,13911,13935,13960,13985,14010,14035,14060,14085,14110,14134,14159
,14184,14209,14234,14259,14284,14309,14334,14359,14384,14409,14434,14459
,14484,14509,14534,14558,14583,14608,14633,14658,14683,14708,14733,14758
,14783,14809,14834,14859,14884,14909,14934,14959,14984,15009,15034,15059
,15084,15109,15134,15159,15184,15209,15234,15259,15285,15310,15335,15360
,15385,15410,15435,15460,15485,15510,15535,15561,15586,15611,15636,15661
,15686,15711,15736,15761,15787,15812,15837,15862,15887,15912,15937,15962
,15988,16013,16038,16063,16088,16113,16138,16164,16189,16214,16239,16264
,16289,16314,16340,16365,16390,16415,16440,16465,16490,16515,16541,16566
,16591,16616,16641,16666,16691,16717,16742,16767,16792,16817,16842,16867
,16892,16918,16943,16968,16993,17018,17043,17068,17093,17119,17144,17169
,17194,17219,17244,17269,17294,17319,17344,17370,17395,17420,17445,17470
,17495,17520,17545,17570,17595,17620,17645,17671,17696,17721,17746,17771
,17796,17821,17846,17871,17896,17921,17946,17971,17996,18021,18046,18071
,18096,18121,18146,18171,18196,18221,18246,18271,18296,18321,18346,18371
,18396,18421,18446,18471,18495,18520,18545,18570,18595,18620,18645,18670
,18695,18720,18745,18769,18794,18819,18844,18869,18894,18919,18943,18968
,18993,19018,19043,19067,19092,19117,19142,19167,19191,19216,19241,19266
,19290,19315,19340,19365,19389,19414,19439,19463,19488,19513,19537,19562
,19587,19611,19636,19661,19685,19710,19734,19759,19784,19808,19833,19857
,19882,19907,19931,19956,19980,20005,20029,20054,20078,20103,20127,20152
,20176,20201,20225,20249,20274,20298,20323,20347,20371,20396,20420,20445
,20469,20493,20518,20542,20566,20590,20615,20639,20663,20688,20712,20736
,20760,20785,20809,20833,20857,20881,20905,20930,20954,20978,21002,21026
,21050,21074,21098,21122,21147,21171,21195,21219,21243,21267,21291,21315
,21339,21363,21386,21410,21434,21458,21482,21506,21530,21554,21578,21601
,21625,21649,21673,21697,21720,21744,21768,21792,21815,21839,21863,21886
,21910,21934,21957,21981,22005,22028,22052,22075,22099,22123,22146,22170
,22193,22217,22240,22264,22287,22311,22334,22357,22381,22404,22428,22451
,22474,22498,22521,22544,22567,22591,22614,22637,22660,22684,22707,22730
,22753,22776,22800,22823,22846,22869,22892,22915,22938,22961,22984,23007
,23030,23053,23076,23099,23122,23145,23168,23190,23213,23236,23259,23282
,23305,23327,23350,23373,23396,23418,23441,23464,23486,23509,23532,23554
,23577,23599,23622,23645,23667,23690,23712,23735,23757,23779,23802,23824
,23847,23869,23891,23914,23936,23958,23981,24003,24025,24047,24070,24092
,24114,24136,24158,24180,24202,24224,24247,24269,24291,24313,24335,24357
,24379,24400,24422,24444,24466,24488,24510,24532,24553,24575,24597,24619
,24640,24662,24684,24706,24727,24749,24770,24792,24814,24835,24857,24878
,24900,24921,24943,24964,24985,25007,25028,25049,25071,25092,25113,25135
,25156,25177,25198,25219,25241,25262,25283,25304,25325,25346,25367,25388
,25409,25430,25451,25472,25493,25514,25535,25555,25576,25597,25618,25639
,25659,25680,25701,25721,25742,25763,25783,25804,25824,25845,25865,25886
,25906,25927,25947,25968,25988,26008,26029,26049,26069,26090,26110,26130
,26150,26170,26191,26211,26231,26251,26271,26291,26311,26331,26351,26371
,26391,26411,26431,26450,26470,26490,26510,26530,26549,26569,26589,26608
,26628,26648,26667,26687,26706,26726,26745,26765,26784,26803,26823,26842
,26862,26881,26900,26919,26939,26958,26977,26996,27015,27034,27054,27073
,27092,27111,27130,27149,27168,27186,27205,27224,27243,27262,27281,27299
,27318,27337,27356,27374,27393,27411,27430,27449,27467,27486,27504,27523
,27541,27559,27578,27596,27614,27633,27651,27669,27687,27706,27724,27742
,27760,27778,27796,27814,27832,27850,27868,27886,27904,27922,27939,27957
,27975,27993,28011,28028,28046,28064,28081,28099,28116,28134,28151,28169
,28186,28204,28221,28238,28256,28273,28290,28308,28325,28342,28359,28376
,28393,28411,28428,28445,28462,28479,28496,28512,28529,28546,28563,28580
,28597,28613,28630,28647,28663,28680,28697,28713,28730,28746,28763,28779
,28796,28812,28828,28845,28861,28877,28894,28910,28926,28942,28958,28974
,28990,29006,29022,29038,29054,29070,29086,29102,29118,29134,29149,29165
,29181,29197,29212,29228,29243,29259,29275,29290,29305,29321,29336,29352
,29367,29382,29398,29413,29428,29443,29458,29474,29489,29504,29519,29534
,29549,29564,29579,29594,29608,29623,29638,29653,29668,29682,29697,29712
,29726,29741,29755,29770,29784,29799,29813,29827,29842,29856,29870,29885
,29899,29913,29927,29941,29955,29970,29984,29998,30012,30025,30039,30053
,30067,30081,30095,30108,30122,30136,30149,30163,30177,30190,30204,30217
,30231,30244,30257,30271,30284,30297,30311,30324,30337,30350,30363,30376
,30390,30403,30416,30429,30441,30454,30467,30480,30493,30506,30518,30531
,30544,30556,30569,30581,30594,30606,30619,30631,30644,30656,30668,30681
,30693,30705,30717,30730,30742,30754,30766,30778,30790,30802,30814,30826
,30837,30849,30861,30873,30885,30896,30908,30919,30931,30943,30954,30966
,30977,30988,31000,31011,31022,31034,31045,31056,31067,31078,31090,31101
,31112,31123,31134,31145,31155,31166,31177,31188,31199,31209,31220,31231
,31241,31252,31262,31273,31283,31294,31304,31315,31325,31335,31345,31356
,31366,31376,31386,31396,31406,31416,31426,31436,31446,31456,31466,31476
,31485,31495,31505,31514,31524,31534,31543,31553,31562,31572,31581,31590
,31600,31609,31618,31628,31637,31646,31655,31664,31673,31682,31691,31700
,31709,31718,31727,31736,31744,31753,31762,31770,31779,31788,31796,31805
,31813,31821,31830,31838,31847,31855,31863,31871,31880,31888,31896,31904
,31912,31920,31928,31936,31944,31951,31959,31967,31975,31983,31990,31998
,32005,32013,32020,32028,32035,32043,32050,32058,32065,32072,32079,32087
,32094,32101,32108,32115,32122,32129,32136,32143,32150,32156,32163,32170
,32177,32183,32190,32196,32203,32210,32216,32222,32229,32235,32242,32248
,32254,32260,32267,32273,32279,32285,32291,32297,32303,32309,32315,32321
,32326,32332,32338,32344,32349,32355,32360,32366,32371,32377,32382,32388
,32393,32398,32404,32409,32414,32419,32424,32430,32435,32440,32445,32450
,32454,32459,32464,32469,32474,32478,32483,32488,32492,32497,32501,32506
,32510,32515,32519,32524,32528,32532,32536,32540,32545,32549,32553,32557
,32561,32565,32569,32573,32576,32580,32584,32588,32591,32595,32599,32602
,32606,32609,32613,32616,32620,32623,32626,32629,32633,32636,32639,32642
,32645,32648,32651,32654,32657,32660,32663,32666,32669,32671,32674,32677
,32679,32682,32684,32687,32689,32692,32694,32696,32699,32701,32703,32705
,32708,32710,32712,32714,32716,32718,32720,32722,32724,32725,32727,32729
,32731,32732,32734,32735,32737,32738,32740,32741,32743,32744,32745,32747
,32748,32749,32750,32751,32752,32753,32754,32755,32756,32757,32758,32759
,32760,32760,32761,32762,32762,32763,32763,32764,32764,32765,32765,32766
,32766,32766,32766,32767,32767,32767,32767,32767,32767,32767,32767,32767
,32767,32766,32766,32766,32766,32765,32765,32764,32764,32763,32763,32762
,32762,32761,32760,32760,32759,32758,32757,32756,32755,32754,32753,32752
,32751,32750,32749,32748,32747,32745,32744,32743,32741,32740,32738,32737
,32735,32734,32732,32731,32729,32727,32725,32724,32722,32720,32718,32716
,32714,32712,32710,32708,32705,32703,32701,32699,32696,32694,32692,32689
,32687,32684,32682,32679,32677,32674,32671,32669,32666,32663,32660,32657
,32654,32651,32648,32645,32642,32639,32636,32633,32629,32626,32623,32620
,32616,32613,32609,32606,32602,32599,32595,32591,32588,32584,32580,32576
,32573,32569,32565,32561,32557,32553,32549,32545,32540,32536,32532,32528
,32524,32519,32515,32510,32506,32501,32497,32492,32488,32483,32478,32474
,32469,32464,32459,32454,32450,32445,32440,32435,32430,32424,32419,32414
,32409,32404,32398,32393,32388,32382,32377,32371,32366,32360,32355,32349
,32344,32338,32332,32326,32321,32315,32309,32303,32297,32291,32285,32279
,32273,32267,32260,32254,32248,32242,32235,32229,32222,32216,32210,32203
,32196,32190,32183,32177,32170,32163,32156,32150,32143,32136,32129,32122
,32115,32108,32101,32094,32087,32079,32072,32065,32058,32050,32043,32035
,32028,32020,32013,32005,31998,31990,31983,31975,31967,31959,31951,31944
,31936,31928,31920,31912,31904,31896,31888,31880,31871,31863,31855,31847
,31838,31830,31821,31813,31805,31796,31788,31779,31770,31762,31753,31744
,31736,31727,31718,31709,31700,31691,31682,31673,31664,31655,31646,31637
,31628,31618,31609,31600,31590,31581,31572,31562,31553,31543,31534,31524
,31514,31505,31495,31485,31476,31466,31456,31446,31436,31426,31416,31406
,31396,31386,31376,31366,31356,31345,31335,31325,31315,31304,31294,31283
,31273,31262,31252,31241,31231,31220,31209,31199,31188,31177,31166,31155
,31145,31134,31123,31112,31101,31090,31078,31067,31056,31045,31034,31022
,31011,31000,30988,30977,30966,30954,30943,30931,30919,30908,30896,30885
,30873,30861,30849,30837,30826,30814,30802,30790,30778,30766,30754,30742
,30730,30717,30705,30693,30681,30668,30656,30644,30631,30619,30606,30594
,30581,30569,30556,30544,30531,30518,30506,30493,30480,30467,30454,30441
,30429,30416,30403,30390,30376,30363,30350,30337,30324,30311,30297,30284
,30271,30257,30244,30231,30217,30204,30190,30177,30163,30149,30136,30122
,30108,30095,30081,30067,30053,30039,30025,30012,29998,29984,29970,29955
,29941,29927,29913,29899,29885,29870,29856,29842,29827,29813,29799,29784
,29770,29755,29741,29726,29712,29697,29682,29668,29653,29638,29623,29608
,29594,29579,29564,29549,29534,29519,29504,29489,29474,29458,29443,29428
,29413,29398,29382,29367,29352,29336,29321,29305,29290,29275,29259,29243
,29228,29212,29197,29181,29165,29149,29134,29118,29102,29086,29070,29054
,29038,29022,29006,28990,28974,28958,28942,28926,28910,28894,28877,28861
,28845,28828,28812,28796,28779,28763,28746,28730,28713,28697,28680,28663
,28647,28630,28613,28597,28580,28563,28546,28529,28512,28496,28479,28462
,28445,28428,28411,28393,28376,28359,28342,28325,28308,28290,28273,28256
,28238,28221,28204,28186,28169,28151,28134,28116,28099,28081,28064,28046
,28028,28011,27993,27975,27957,27939,27922,27904,27886,27868,27850,27832
,27814,27796,27778,27760,27742,27724,27706,27687,27669,27651,27633,27614
,27596,27578,27559,27541,27523,27504,27486,27467,27449,27430,27411,27393
,27374,27356,27337,27318,27299,27281,27262,27243,27224,27205,27186,27168
,27149,27130,27111,27092,27073,27054,27034,27015,26996,26977,26958,26939
,26919,26900,26881,26862,26842,26823,26803,26784,26765,26745,26726,26706
,26687,26667,26648,26628,26608,26589,26569,26549,26530,26510,26490,26470
,26450,26431,26411,26391,26371,26351,26331,26311,26291,26271,26251,26231
,26211,26191,26170,26150,26130,26110,26090,26069,26049,26029,26008,25988
,25968,25947,25927,25906,25886,25865,25845,25824,25804,25783,25763,25742
,25721,25701,25680,25659,25639,25618,25597,25576,25555,25535,25514,25493
,25472,25451,25430,25409,25388,25367,25346,25325,25304,25283,25262,25241
,25219,25198,25177,25156,25135,25113,25092,25071,25049,25028,25007,24985
,24964,24943,24921,24900,24878,24857,24835,24814,24792,24770,24749,24727
,24706,24684,24662,24640,24619,24597,24575,24553,24532,24510,24488,24466
,24444,24422,24400,24379,24357,24335,24313,24291,24269,24247,24224,24202
,24180,24158,24136,24114,24092,24070,24047,24025,24003,23981,23958,23936
,23914,23891,23869,23847,23824,23802,23779,23757,23735,23712,23690,23667
,23645,23622,23599,23577,23554,23532,23509,23486,23464,23441,23418,23396
,23373,23350,23327,23305,23282,23259,23236,23213,23190,23168,23145,23122
,23099,23076,23053,23030,23007,22984,22961,22938,22915,22892,22869,22846
,22823,22800,22776,22753,22730,22707,22684,22660,22637,22614,22591,22567
,22544,22521,22498,22474,22451,22428,22404,22381,22357,22334,22311,22287
,22264,22240,22217,22193,22170,22146,22123,22099,22075,22052,22028,22005
,21981,21957,21934,21910,21886,21863,21839,21815,21792,21768,21744,21720
,21697,21673,21649,21625,21601,21578,21554,21530,21506,21482,21458,21434
,21410,21386,21363,21339,21315,21291,21267,21243,21219,21195,21171,21147
,21122,21098,21074,21050,21026,21002,20978,20954,20930,20905,20881,20857
,20833,20809,20785,20760,20736,20712,20688,20663,20639,20615,20590,20566
,20542,20518,20493,20469,20445,20420,20396,20371,20347,20323,20298,20274
,20249,20225,20201,20176,20152,20127,20103,20078,20054,20029,20005,19980
,19956,19931,19907,19882,19857,19833,19808,19784,19759,19734,19710,19685
,19661,19636,19611,19587,19562,19537,19513,19488,19463,19439,19414,19389
,19365,19340,19315,19290,19266,19241,19216,19191,19167,19142,19117,19092
,19067,19043,19018,18993,18968,18943,18919,18894,18869,18844,18819,18794
,18769,18745,18720,18695,18670,18645,18620,18595,18570,18545,18520,18495
,18471,18446,18421,18396,18371,18346,18321,18296,18271,18246,18221,18196
,18171,18146,18121,18096,18071,18046,18021,17996,17971,17946,17921,17896
,17871,17846,17821,17796,17771,17746,17721,17696,17671,17645,17620,17595
,17570,17545,17520,17495,17470,17445,17420,17395,17370,17344,17319,17294
,17269,17244,17219,17194,17169,17144,17119,17093,17068,17043,17018,16993
,16968,16943,16918,16892,16867,16842,16817,16792,16767,16742,16717,16691
,16666,16641,16616,16591,16566,16541,16515,16490,16465,16440,16415,16390
,16365,16340,16314,16289,16264,16239,16214,16189,16164,16138,16113,16088
,16063,16038,16013,15988,15962,15937,15912,15887,15862,15837,15812,15787
,15761,15736,15711,15686,15661,15636,15611,15586,15561,15535,15510,15485
,15460,15435,15410,15385,15360,15335,15310,15285,15259,15234,15209,15184
,15159,15134,15109,15084,15059,15034,15009,14984,14959,14934,14909,14884
,14859,14834,14809,14783,14758,14733,14708,14683,14658,14633,14608,14583
,14558,14534,14509,14484,14459,14434,14409,14384,14359,14334,14309,14284
,14259,14234,14209,14184,14159,14134,14110,14085,14060,14035,14010,13985
,13960,13935,13911,13886,13861,13836,13811,13786,13762,13737,13712,13687
,13662,13638,13613,13588,13563,13539,13514,13489,13464,13440,13415,13390
,13365,13341,13316,13291,13267,13242,13217,13193,13168,13143,13119,13094
,13069,13045,13020,12996,12971,12946,12922,12897,12873,12848,12824,12799
,12775,12750,12726,12701,12677,12652,12628,12603,12579,12554,12530,12505
,12481,12457,12432,12408,12383,12359,12335,12310,12286,12262,12237,12213
,12189,12164,12140,12116,12092,12067,12043,12019,11995,11970,11946,11922
,11898,11874,11849,11825,11801,11777,11753,11729,11705,11681,11657,11633
,11608,11584,11560,11536,11512,11488,11464,11440,11416,11392,11369,11345
,11321,11297,11273,11249,11225,11201,11177,11154,11130,11106,11082,11058
,11035,11011,10987,10963,10940,10916,10892,10869,10845,10821,10798,10774
,10750,10727,10703,10680,10656,10633,10609,10586,10562,10539,10515,10492
,10468,10445,10421,10398,10375,10351,10328,10304,10281,10258,10234,10211
,10188,10165,10141,10118,10095,10072,10049,10025,10002,9979,9956,9933
,9910,9887,9864,9841,9817,9794,9771,9748,9725,9703,9680,9657
,9634,9611,9588,9565,9542,9519,9497,9474,9451,9428,9405,9383
,9360,9337,9315,9292,9269,9247,9224,9201,9179,9156,9134,9111
,9089,9066,9044,9021,8999,8976,8954,8932,8909,8887,8864,8842
,8820,8798,8775,8753,8731,8709,8686,8664,8642,8620,8598,8576
,8554,8531,8509,8487,8465,8443,8421,8399,8377,8356,8334,8312
,8290,8268,8246,8224,8203,8181,8159,8137,8116,8094,8072,8051
,8029,8007,7986,7964,7943,7921,7900,7878,7857,7835,7814,7792
,7771,7750,7728,7707,7686,7664,7643,7622,7601,7579,7558,7537
,7516,7495,7474,7453,7431,7410,7389,7368,7347,7326,7305,7285
,7264,7243,7222,7201,7180,7160,7139,7118,7097,7077,7056,7035
,7015,6994,6973,6953,6932,6912,6891,6871,6850,6830,6810,6789
,6769,6748,6728,6708,6688,6667,6647,6627,6607,6587,6566,6546
,6526,6506,6486,6466,6446,6426,6406,6386,6366,6346,6327,6307
,6287,6267,6247,6228,6208,6188,6169,6149,6129,6110,6090,6071
,6051,6032,6012,5993,5973,5954,5934,5915,5896,5876,5857,5838
,5819,5800,5780,5761,5742,5723,5704,5685,5666,5647,5628,5609
,5590,5571,5552,5533,5515,5496,5477,5458,5439,5421,5402,5383
,5365,5346,5328,5309,5291,5272,5254,5235,5217,5198,5180,5162
,5144,5125,5107,5089,5071,5052,5034,5016,4998,4980,4962,4944
,4926,4908,4890,4872,4854,4836,4819,4801,4783,4765,4748,4730
,4712,4695,4677,4659,4642,4624,4607,4589,4572,4555,4537,4520
,4503,4485,4468,4451,4434,4416,4399,4382,4365,4348,4331,4314
,4297,4280,4263,4246,4229,4212,4196,4179,4162,4145,4129,4112
,4095,4079,4062,4046,4029,4013,3996,3980,3963,3947,3930,3914
,3898,3882,3865,3849,3833,3817,3801,3785,3769,3753,3737,3721
,3705,3689,3673,3657,3641,3625,3610,3594,3578,3563,3547,3531
,3516,3500,3485,3469,3454,3438,3423,3408,3392,3377,3362,3346
,3331,3316,3301,3286,3271,3256,3241,3226,3211,3196,3181,3166
,3151,3136,3122,3107,3092,3077,3063,3048,3034,3019,3005,2990
,2976,2961,2947,2932,2918,2904,2889,2875,2861,2847,2833,2819
,2804,2790,2776,2762,2748,2735,2721,2707,2693,2679,2665,2652
,2638,2624,2611,2597,2584,2570,2557,2543,2530,2516,2503,2490
,2476,2463,2450,2436,2423,2410,2397,2384,2371,2358,2345,2332
,2319,2306,2293,2281,2268,2255,2242,2230,2217,2204,2192,2179
,2167,2154,2142,2129,2117,2105,2092,2080,2068,2056,2044,2031
,2019,2007,1995,1983,1971,1959,1947,1935,1924,1912,1900,1888
,1877,1865,1853,1842,1830,1819,1807,1796,1784,1773,1762,1750
,1739,1728,1716,1705,1694,1683,1672,1661,1650,1639,1628,1617
,1606,1595,1585,1574,1563,1552,1542,1531,1520,1510,1499,1489
,1478,1468,1458,1447,1437,1427,1416,1406,1396,1386,1376,1366
,1356,1346,1336,1326,1316,1306,1296,1286,1277,1267,1257,1248
,1238,1229,1219,1210,1200,1191,1181,1172,1163,1153,1144,1135
,1126,1117,1107,1098,1089,1080,1071,1062,1054,1045,1036,1027
,1018,1010,1001, 992, 984, 975, 967, 958, 950, 941, 933, 925
, 916, 908, 900, 892, 883, 875, 867, 859, 851, 843, 835, 827
, 819, 812, 804, 796, 788, 781, 773, 765, 758, 750, 743, 735
, 728, 720, 713, 706, 699, 691, 684, 677, 670, 663, 656, 649
, 642, 635, 628, 621, 614, 607, 600, 594, 587, 580, 574, 567
, 561, 554, 548, 541, 535, 529, 522, 516, 510, 504, 497, 491
, 485, 479, 473, 467, 461, 455, 449, 444, 438, 432, 426, 421
, 415, 409, 404, 398, 393, 387, 382, 377, 371, 366, 361, 355
, 350, 345, 340, 335, 330, 325, 320, 315, 310, 305, 300, 296
, 291, 286, 282, 277, 272, 268, 263, 259, 254, 250, 246, 241
, 237, 233, 229, 224, 220, 216, 212, 208, 204, 200, 196, 192
, 189, 185, 181, 177, 174, 170, 167, 163, 159, 156, 153, 149
, 146, 142, 139, 136, 133, 130, 126, 123, 120, 117, 114, 111
, 108, 105, 103, 100,97,94,92,89,86,84,81,79
,76,74,72,69,67,65,63,60,58,56,54,52
,50,48,46,44,43,41,39,37,36,34,32,31
,29,28,26,25,24,22,21,20,19,17,16,15
,14,13,12,11,10, 9, 9, 8, 7, 6, 6, 5
, 4, 4, 3, 3, 2, 2, 2, 1, 1, 1, 0, 0
, 0, 0, 0, 0
};

class AudioAnalyzeFFT4096 : public AudioStream
{
public:
	AudioAnalyzeFFT4096() : AudioStream(1, inputQueueArray),
	  state(0), outputflag(false), samplingRatioDiv(1), blockCounter(0), bHalfSample(false) {
		//arm_cfft_radix4_init_q15(&fft_inst, 1024, 0, 1);
	}
	bool available() {
		if (outputflag == true) {
			outputflag = false;
			return true;
		}
		return false;
	}
	float read(q15_t binNumber) {
		if (binNumber > 2047) return 0.0;						// half FFT size
		//Serial.println((int)(output[binNumber]));
		return (float)(output[binNumber]);// * (1.0 / 16384.0);
	}
	float read(unsigned int binFirst, unsigned int binLast) {
		if (binFirst > binLast) {
			unsigned int tmp = binLast;
			binLast = binFirst;
			binFirst = tmp;
		}
		if (binFirst > 2047) return 0.0;
		if (binLast > 2047) binLast = 2047;
		uint32_t sum = 0;
		do {
			sum += output[binFirst++];
		} while (binFirst <= binLast);
		return (float)sum * (1.0 / 16384.0);
	}
	void averageTogether(uint8_t n) {
		// not implemented yet (may never be, 86 Hz output rate is ok)
	}
	void useWindowFunction(bool b)
	{
		bWindowFunction = b;
	}
	void samplingRatioDivider(int d)
	{
		samplingRatioDiv = d;
		Serial.print("max frequency: ");
		Serial.print(44100/samplingRatioDiv);
		Serial.print(" frequency step: ");
		Serial.print((44100/samplingRatioDiv) / 4096.0);
		Serial.print(" samples per block: ");
		Serial.println(AUDIO_BLOCK_SAMPLES);
	}
	void halfSampling(bool b)
	{
			bHalfSample = b;
	}
	void WipeBuffer()
	{
		state = 0;
		outputflag = false;
		blockCounter = 0;
	}
	float peakFrequency()
	{
		 uint32_t testIndex = 0;
		 q15_t maxValue;
		// Serial.print("Max value: ");
		// Serial.println((int)(maxValue));
		// Serial.print(output[28]);
		 arm_max_q15(output, 4096, &maxValue, &testIndex);		// half FFT size
		 Serial.print( "testindex: ");
		 Serial.print(testIndex);
		 Serial.print(" value at max: ");
		 Serial.println(output[testIndex]);
		
		if(bHalfSample)
		{
			return testIndex * (44100/2) / 4096.0;						// full FFT size
		}
		else
		{
			return testIndex * (44100) / 4096.0;						// full FFT size
		}
		
	}
	
	virtual void update(void);
	int16_t output[4096] __attribute__ ((aligned (4)));		// half FFT size
private:
	void init(void);
	audio_block_t *blocklist[32];
	int16_t buffer[4096] __attribute__ ((aligned (4)));			// double FFT size
	//int16_t buffer2[8192] __attribute__ ((aligned (4)));			// double FFT size
	uint8_t state;
	volatile bool outputflag;
	audio_block_t *inputQueueArray[1];
	bool bWindowFunction;
	int samplingRatioDiv;
	int blockCounter;
	bool bHalfSample;
};

#endif
